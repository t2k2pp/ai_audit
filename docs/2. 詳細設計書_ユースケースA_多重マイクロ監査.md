# **詳細設計書：ユースケースA（バックグラウンド多重マイクロ監査）**

**対象モジュール:** CLIデーモン（コアエンジン）

**対象言語:** Python / JavaScript / TypeScript / TSX（v0.3.0〜 tree-sitter によりJS/TS対応）

**目的:** ファイル保存時に、対象コードを関数単位に分割し、複数の異なるプロンプト（ウェア）でLLMに監査させ、結果をJSONで出力する。

## **1\. 処理シーケンス（データフロー）**

1. **\[トリガー\]** VS Code等のエディタから、保存されたファイルの絶対パスがCLIデーモンに通知される。
2. **\[解析\]** 拡張子に応じてASTパーサーを切り替えてソースコードを解析する。Pythonは `ast` ライブラリ、JS/TS/TSXは `tree-sitter` を使用し、関数定義・クラス定義ごとにコード文字列（チャンク）を抽出する。プロンプト内のコードブロックには言語タグ（`python` / `javascript` / `typescript`）を付与する。
3. **\[キャッシュ判定\]** 抽出した各チャンクのSHA-256ハッシュを計算し、ローカルDB（後述）に存在し、かつ変更がなければスキップする。  
4. **\[推論実行ループ\]** 変更があったチャンクに対し、定義された複数の「ウェア（システムプロンプト）」を順番に適用し、LLM（120Bモデル等）へAPIリクエストを送信する。  
5. **\[保存\]** LLMからのJSONレスポンスをパースし、ローカルDBの監査結果テーブルに保存（UPSERT）する。

## **2\. ウェア（プロンプト）設計定義**

LLMの視界を極端に狭め、特定のタスクに集中させるためのシステムプロンプト定義。

### **ウェア1: セキュリティ監査 (Security Auditor)**

* **役割:** 脆弱性の検知  
* **システムプロンプト例:**  
  あなたは世界トップクラスのセキュリティエンジニアです。  
  提供された数十行のコード片のみを読み込み、インジェクション（SQL/OS/Command）、クロスサイトスクリプティング（XSS）、認証不備、機密情報のハードコード、リソース枯渇などの脆弱性が存在しないか厳格に監査してください。  
  コードの全体的な文脈や、他のファイルの依存関係は一切無視して構いません。目の前にあるコードの局所的な安全性の評価のみを行ってください。

### **ウェア2: クリーンコード監査 (Clean Code Reviewer)**

* **役割:** 可読性と命名規則のチェック  
* **システムプロンプト例:**  
  あなたは経験豊富なシニアソフトウェアエンジニアです。  
  提供されたコード片の「可読性」「命名規則」「認知負荷」についてのみ監査してください。  
  変数の名前が実態を表しているか、不要にネストが深くなっていないか、1つの関数が複数の責務を持ちすぎていないかを指摘してください。  
  セキュリティやパフォーマンスの指摘は不要です。

## **3\. 入出力データ構造（APIインターフェース）**

LLMからの出力は、プログラム（VS Code等）が解析しやすいように、厳格なJSONフォーマットを要求する（JSON Modeの利用を前提）。

**LLMへの要求フォーマット (JSON Schema):**

{  
  "issues": \[  
    {  
      "type": "string (例: security, readability, performance)",  
      "severity": "string (high, medium, low)",  
      "line\_number\_offset": "integer (関数先頭からの相対行数。指摘がない場合はnull)",  
      "description": "string (日本語での指摘内容)",  
      "suggestion": "string (具体的な修正コード案やアドバイス)"  
    }  
  \]  
}

## **4\. ローカルDB (SQLite) スキーマ設計**

同じコードに対する無駄な推論を防ぐためのキャッシュ層と、結果の保存先。

**テーブル: chunk\_cache** (解析済みコードのハッシュ管理)

* chunk\_id (TEXT, PK): チャンクの一意識別子（例: ファイルパス:関数名）  
* hash (TEXT): コード文字列のSHA-256ハッシュ  
* last\_audited\_at (DATETIME): 最終監査日時

**テーブル: audit\_results** (LLMの監査結果)

* id (INTEGER, PK): 自動連番  
* chunk\_id (TEXT, FK): 対象のチャンクID  
* wear\_type (TEXT): 使用したウェア（例: security, readability）  
* severity (TEXT): 重要度  
* description (TEXT): 指摘内容  
* suggestion (TEXT): 修正案  
* status (TEXT): 状態（open, resolved, ignored）