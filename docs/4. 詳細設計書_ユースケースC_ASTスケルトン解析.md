# **詳細設計書：ユースケースC（ASTスケルトン解析によるマクロ・レビュー）**

**対象モジュール:** オンデマンドCLIツール

**対象言語:** Python / JavaScript / TypeScript / TSX（v0.3.0〜 tree-sitter によりJS/TS対応）

**目的:** 4096トークンという厳しいコンテキスト制限下で、AIに複数ファイルにまたがるモジュールの「全体像（アーキテクチャ）」を把握させ、構造的なレビューやリファクタリング計画を立案させる。

## **1\. 処理シーケンス（データフロー）**

本ユースケースはデータベースを必要とせず、実行時にコードを圧縮（スケルトン化）してAIに評価させる、完全にスタンドアローンなツールとして動作する。

1. **\[トリガー\]** 開発者がCLIで評価対象のディレクトリを指定して実行（例: review\_architecture ./src/models）。  
2. **\[スケルトン化処理 (AST解析)\]** 拡張子に応じてパーサーを自動選択する（Python: `ast`、JS/TS/TSX: `tree-sitter`）。ASTツリーをトラバース（巡回）し、関数の内部処理（if文、forループ、変数代入などの実装詳細ブロック）をすべて削除（スキップ）する。クラス宣言、関数シグネチャ（名前、引数、戻り値の型）、Docstring / JSDoc コメント、型アノテーションのみを残した「スケルトンコード（骨組み）」を生成する。JS/TSファイルが含まれる場合は、出力レポートに注記を自動挿入する。
3. **\[コンテキスト結合\]** 複数のファイルから生成したスケルトンコードを、ファイルパスを明記した上で1つのテキストデータに結合する。  
4. **\[推論実行\]** 結合したスケルトンコード（大幅にトークンが削減されているため、4096トークン内におそらく複数ファイル分が収まる）と、「アーキテクチャ・レビューウェア」をAIに送信する。  
5. **\[レポート出力\]** AIからの全体レビュー結果をMarkdownファイル等で標準出力または保存する。

## **2\. ウェア（プロンプト）設計定義**

実装の細部が存在しない「骨組み」の情報だけを基に、システム設計の妥当性を評価させるプロンプト。

### **ウェア: ソフトウェア・アーキテクト（構造レビュアー）**

* **システムプロンプト例:**  
  あなたはシステム全体の構造設計を評価するシニア・アーキテクトです。  
  提供されるのは、複数ファイルから実装の詳細（アルゴリズム等）を削ぎ落とし、クラス名、関数シグネチャ、コメントのみを残した「スケルトンコード」です。

  このインターフェースと構造の情報のみを用いて、以下の観点でシステムアーキテクチャのレビューを行ってください。  
  1\. 責務の偏り（God Classや、肥大化しすぎているモジュールがないか）。  
  2\. 依存関係の乱れ（循環参照の可能性や、抽象化が不足している箇所）。  
  3\. クラス名や関数名から推測される、ドメインモデリングの妥当性。  
  4\. 今後システムを拡張する上での、構造的なボトルネックの指摘。

  局所的なバグやコーディングスタイルではなく、モジュール間の関係性というマクロな視点でのみ回答してください。

## **3\. スケルトン化の出力イメージ（データ構造）**

AIへ入力されるデータのイメージ（実装が削ぎ落とされている状態）。

**生成されるスケルトン文字列の例:**

\=== File: src/user\_service.py \===  
class UserService:  
    """ユーザーのライフサイクルを管理するサービス"""  
      
    def register\_user(self, email: str, password\_hash: str) \-\> UserRecord:  
        """新規ユーザーをDBに登録し、初期設定を行う"""  
        pass \# 実装省略

    def notify\_admin\_of\_new\_user(self, user\_id: str) \-\> None:  
        pass \# 実装省略

\=== File: src/payment\_service.py \===  
class PaymentService:  
    def process\_subscription(self, user\_id: str, plan\_id: str) \-\> bool:  
        """外部決済APIを呼び出し、課金処理を行う"""  
        pass \# 実装省略

※ このように圧縮することで、数千行の実装コードを数百トークン程度に抑え込み、4096トークン制限下でも「UserService と PaymentService の役割分担」などをAIに評価させることが可能になる。