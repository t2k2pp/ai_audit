# **詳細設計書：ユースケースD（スケルトン解析による設計書の逆生成）**

**対象モジュール:** オンデマンドCLIツール / VSCode拡張

**対象言語:** Python / JavaScript / TypeScript / TSX

**目的:** ASTスケルトン解析技術を応用し、コードから詳細設計書・概要設計書を自動生成する。ドキュメントが存在しないレガシーコードや、スパゲッティ化したコードベースへの対処を主なユースケースとする。

---

## **1\. ユースケースと活用パターン**

### パターン1: 内部利用（詳細設計書目的）

ドキュメントが存在しないレガシーコードを引き継いだ際に、まず設計書を起こして全体像を把握する。

- **対象:** チーム内部の開発者
- **主要成果物:** `_design_detail.md`（詳細設計書）
- **活用例:** 既存システムへの機能追加前の調査、レビュー、リファクタリング計画

### パターン2: リビルド支援（概要設計書目的）

スパゲッティ化したコードから概要設計書を生成し、AIにクリーンな再実装を依頼する際の入力資料とする。

- **対象:** AI・LLMへの入力、または外部への説明
- **主要成果物:** `_design_overview.md`（概要設計書）
- **活用例:** 「この設計書に基づいて新しく実装してください」といったAIへの指示

---

## **2\. 処理シーケンス（データフロー）**

本ユースケースは2段階のLLMパイプラインで動作する。

```
[トリガー]
  CLIコマンド: generate_design_doc <directory>
  VSCode: フォルダ右クリック → "ドキュメント生成：設計書"
         ↓
[Phase 1: スケルトン化]
  ast_parser.scan_source_files()  ← Python + JS/TS/TSX を対象
  ast_parser.generate_skeleton()  ← 実装ブロックを除去、シグネチャ/Docstring/JSDoc/型のみ残す
         ↓
[Phase 2: 詳細設計書生成]
  _split_batches() でバッチ分割（DEFAULT_CHAR_LIMIT 基準）
  DETAIL_DESIGNER_WEAR でLLMに送信
  → 各バッチの結果を結合
  → _design_detail.md に書き出し
         ↓
[Phase 3: 概要設計書生成]
  _design_detail.md を読み込み
  OVERVIEW_DESIGNER_WEAR でLLMに送信（1回）
  → _design_overview.md に書き出し
```

---

## **3\. 再開・強制再生成の仕様**

| 状況 | 動作 |
|---|---|
| `_design_detail.md` が存在しない | Phase 2（詳細生成）から開始 |
| `_design_detail.md` が存在する + `--force` なし | Phase 2 をスキップし、Phase 3（概要生成）から再開 |
| `--force` あり | Phase 2・3 を両方実行（全体再生成） |

---

## **4\. 出力ファイル仕様**

| ファイル名 | 内容 | 対象読者 |
|---|---|---|
| `_design_detail.md` | 詳細設計書。クラス・関数レベルの責務、引数/戻り値、内部構造、Mermaid図を含む | チーム内部の開発者 |
| `_design_overview.md` | 概要設計書。機能概要・コンポーネント構成・外部インターフェースをコンパクトに記述 | AI・LLMへの入力、外部説明 |

**出力先:** デフォルトは解析対象フォルダの直下。`--output-dir` で変更可。

---

## **5\. ウェア（プロンプト）設計定義**

### **ウェア: 詳細設計書生成（DETAIL_DESIGNER_WEAR）**

- **役割:** スケルトンコードから詳細設計書を生成するシニアエンジニア
- **入力:** ASTスケルトンコード（複数ファイル分）
- **出力:** Markdown形式の詳細設計書
  - モジュール・クラスごとの責務説明
  - 関数・メソッドの引数/戻り値/処理概要
  - モジュール間の依存関係（Mermaid diagram）
  - 重要な設計判断の推測・記述

### **ウェア: 概要設計書生成（OVERVIEW_DESIGNER_WEAR）**

- **役割:** 詳細設計書から外部向けの概要設計書を作成するテクニカルライター
- **入力:** `_design_detail.md` の内容
- **出力:** Markdown形式の概要設計書
  - システム・モジュールの目的と概要
  - 主要機能の一覧
  - コンポーネント構成図（Mermaid）
  - 外部インターフェース・API概要

---

## **6\. JS/TS 対応と注意事項**

JS/TS ファイルが対象フォルダに含まれる場合、以下の注記が設計書の冒頭に自動挿入される：

```
> ⚠️ 注記: このフォルダにはJavaScript/TypeScriptファイルが含まれています。
> 現バージョンの解析ウェアはJS/TS固有のベストプラクティス（型安全性、
> 非同期処理パターン等）に特化した観点を持っていません。
> 設計書の内容はあくまで参考としてご利用ください。
```

---

## **7\. バッチ分割の仕様**

大規模プロジェクトではスケルトンコードが1回のLLMリクエストに収まらない場合がある。

- `DEFAULT_CHAR_LIMIT` を基準に、ファイル単位でバッチを分割
- 各バッチを個別にLLMへ送信し、結果を順に `_design_detail.md` へ追記
- バッチ境界はファイル境界に合わせる（ファイルを分断しない）

---

## **8\. CLIインターフェース**

```bash
# 基本実行（対象フォルダ直下に出力）
python main.py generate_design_doc ./src

# 出力先を指定
python main.py generate_design_doc ./src --output-dir ./docs

# 強制再生成（_design_detail.md があっても最初からやり直す）
python main.py generate_design_doc ./src --force
```

---

## **9\. VSCode拡張のインターフェース**

- **トリガー1:** エクスプローラーでフォルダを右クリック → `ai_audit: ドキュメント生成：設計書`
- **トリガー2:** コマンドパレット（`Ctrl+Shift+P`） → `ai_audit: ドキュメント生成：設計書` → フォルダ選択ダイアログ
- **完了後:** `_design_detail.md` と `_design_overview.md` を WebView で自動表示

---

## **10\. 実装モジュール構成**

```
usecase_d.py
  generate_design_doc(directory, output_dir, force)
    ├─ _generate_detail(directory, output_path, has_jsts)
    │    ├─ ast_parser.scan_source_files()
    │    ├─ ast_parser.generate_skeleton()
    │    ├─ _split_batches()
    │    └─ llm_client.call_llm() × バッチ数
    └─ _generate_overview(detail_path, output_path, has_jsts)
         └─ llm_client.call_llm() × 1回

wear_manager.py
  DETAIL_DESIGNER_WEAR    ← 詳細設計書生成プロンプト
  OVERVIEW_DESIGNER_WEAR  ← 概要設計書生成プロンプト

ast_parser.py
  scan_source_files()     ← Python + JS/TS を対象に収集
  generate_skeleton()     ← Python（ast）/ JS/TS（tree-sitter）両対応
```
