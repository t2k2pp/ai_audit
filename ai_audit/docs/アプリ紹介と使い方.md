# ai_audit - アプリ紹介と使い方

**作成日:** 2026年2月

---

## このツールは何か

`ai_audit` は、社内オンプレミス環境の120Bクラス生成AIモデル（Ollama 等の OpenAI 互換 API）を活用し、
**コードレビューの自動化・設計思想の蓄積・アーキテクチャの俯瞰**を行うCLIツールです。

4096トークンというコンテキスト制限を「チャンク化×ウェア切り替え」で克服し、
推論コスト無制限の社内環境でバックグラウンド多重推論を行います。

また、**VSCode 拡張機能**（`vscode-extension/`）を使うと、ファイル保存時に自動で監査が走り、
エディタ上に問題箇所を波線で表示します（ターミナル操作不要）。

---

## 前提環境

| 項目 | 要件 |
|---|---|
| OS | Windows / macOS / Linux |
| Python | 3.9 以上（`ast.unparse` を使用） |
| LLM | OpenAI互換API（GPT-oss-120b / Ollama 等）が稼働していること |

---

## セットアップ

### 1. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

インストールされるパッケージ:

| パッケージ | 用途 |
|---|---|
| `chromadb` | ユースケースB: ベクトルストア |
| `requests` | LLM APIへのHTTPリクエスト |
| `python-dotenv` | `.env` ファイルの読み込み |

### 2. 環境変数の設定

```bash
cp .env.example .env
```

`.env` を以下の内容で編集してください（`.env.example` に詳細コメントあり）:

```env
# --- Ollama を使う場合 ---
LLM_API_BASE_URL=http://192.168.1.40:11434/v1
LLM_API_KEY=ollama
LLM_MODEL_NAME=gpt-oss:120b

# --- OpenAI API を使う場合 ---
# LLM_API_BASE_URL=https://api.openai.com/v1
# LLM_API_KEY=sk-...
# LLM_MODEL_NAME=gpt-4o

# キャッシュDB・ベクトルDBの保存先（デフォルト: ~/.ai_audit/）
AI_AUDIT_DATA_DIR=~/.ai_audit
```

### 3. 設定確認・モデル選択（推奨）

```bash
# 現在の設定を確認
python main.py config

# Ollamaのモデル一覧を表示してインデックスで切り替え
python main.py config model
```

---

## 機能一覧

```
python main.py <コマンド> [オプション]
```

| コマンド | ユースケース | 概要 |
|---|---|---|
| `config` | - | 設定の表示・モデル切り替え・出力トークン数設定 |
| `audit <path>` | A | セキュリティ・クリーンコードの多重マイクロ監査（ファイル／フォルダ対応） |
| `extract_why <dir>` | B | 設計思想（Why）の抽出とベクトルDB蓄積 |
| `search_why "<query>"` | B | 蓄積した設計思想への自然言語検索 |
| `review_architecture <dir>` | C | ASTスケルトン解析によるアーキテクチャレビュー |

---

## 設定管理（config コマンド）

### 現在の設定を表示

```bash
python main.py config
```

**出力例:**
```
現在の設定:
  API URL     : http://192.168.1.40:11434/v1
  モデル名    : gpt-oss:120b
  最大出力トークン: モデルのデフォルト最大値（指定なし）
  設定ファイル: C:\Users\username\.ai_audit\config.json
```

### モデルの切り替え

```bash
python main.py config model
```

**操作例:**
```
Ollama (http://192.168.1.40:11434/v1) からモデルリストを取得中...

 No  モデル名                             パラメータ   量子化      サイズ
---------------------------------------------------------------------------
  0  gpt-oss:120b                          116.8B  MXFP4      62.4 GB << 使用中
  1  llama3.1:8b                             8.0B  Q4_K_M      4.9 GB
  2  codestral:22b                          22.0B  Q4_K_M     12.9 GB

切り替えるモデルの番号を入力してください (Enterでキャンセル): 2
[OK]モデルを codestral:22b に変更しました。
```

設定は `~/.ai_audit/config.json` に保存されます。

### 最大出力トークン数の設定

```bash
# 現在の設定を確認
python main.py config output-tokens

# 明示的に上限を指定（大きいほど詳細な指摘、推論時間は増加）
python main.py config output-tokens 4096

# モデルのデフォルト最大値を使用（max_tokens をAPIに送らない）
python main.py config output-tokens auto
```

> **補足: トークンの種類について**
>
> | 種別 | 制御場所 | 説明 |
> |---|---|---|
> | 入力トークン | 内部固定（~2000文字） | コードのチャンクサイズ上限 |
> | 出力トークン | `output-tokens` で設定 | LLMが返す回答の最大長 |
> | コンテキスト全体 | モデル側の固定上限 | 入力＋出力の合計上限（120B≒4096） |

---

## ユースケースA: 多重マイクロ監査

### 概要

指定したPythonファイル（またはフォルダ）を関数・クラス単位に分割し、
「セキュリティ専門家」と「クリーンコードレビュアー」の2つの視点でAIが監査します。
結果はJSONファイルとして出力されます。

### コマンド

```bash
# 単一ファイルを監査 → <ファイル名>_audit.json を出力
python main.py audit src/user_service.py

# フォルダ一括監査 → 各 _audit.json + _summary_audit.json を出力
python main.py audit ./src

# 出力先ディレクトリを指定
python main.py audit ./src --output-dir ./audit_results

# キャッシュを無視して再監査
python main.py audit src/user_service.py --force
```

### 使用例

```bash
python main.py audit src/user_service.py
```

**出力例（ターミナル）:**

```
[INFO] 監査開始: /path/to/src/user_service.py
[INFO] 3 チャンクを抽出しました。
  [AUDIT] function: register_user
    [security] 2 件の指摘
    [readability] 1 件の指摘
  [SKIP] notify_admin_of_new_user (キャッシュヒット)
  [AUDIT] class: UserService
    [security] 0 件の指摘
    [readability] 1 件の指摘
[INFO] 監査結果を保存しました: /path/to/src/user_service_audit.json
```

**出力ファイル (`user_service_audit.json`) の形式:**

```json
{
  "source_file": "/path/to/src/user_service.py",
  "chunks": [
    {
      "chunk_id": "/path/to/src/user_service.py:register_user",
      "issues": [
        {
          "type": "security",
          "severity": "high",
          "line_number_offset": null,
          "description": "パスワードが平文でログに記録される可能性があります。",
          "suggestion": "logging.info() にパスワードが含まれないよう引数を見直してください。"
        }
      ]
    }
  ],
  "total_issues": 3
}
```

### フォルダ一括監査時の追加出力（`_summary_audit.json`）

```json
{
  "scanned_at": "2026-02-20T14:30:00",
  "total_files": 8,
  "files": [
    {
      "source_file": "src/user_service.py",
      "total_issues": 3,
      "high_severity": 1
    }
  ]
}
```

### キャッシュ機能

- 関数のコードをSHA-256ハッシュ化し、変更がなければLLM推論をスキップします
- キャッシュDB: `~/.ai_audit/cache.db`（SQLite）
- `--force` オプションでキャッシュを無視できます

---

## ユースケースB: 設計思想の抽出と検索

### 概要

120Bモデルの高い推論能力を使い、コードの「振る舞い（What）」ではなく
「なぜそのように書かれたか（Why）」を推測・蓄積します。
新規参画メンバーや機能追加時のコードリーディングに活用できます。

### ステップ1: 設計思想の抽出（バッチ実行）

```bash
python main.py extract_why <ディレクトリ>
```

**使用例:**

```bash
python main.py extract_why ./src
```

**出力例（ターミナル）:**

```
  [EXTRACT] register_user: この実装はレガシーな認証システムとの互換性を保つため...
  [EXTRACT] process_subscription: 外部決済APIがREST標準に準拠していないため...
[INFO] 完了: 12 件を抽出・保存, 3 件はスキップ（既存）
```

- 抽出結果はローカルのベクトルDB（ChromaDB）に保存されます
- 既に抽出済みの関数はスキップされます（冪等性）
- CI/CDパイプラインの定期ジョブとして実行することも想定しています

### ステップ2: 設計思想の検索

```bash
python main.py search_why "<自然言語クエリ>"
```

**使用例:**

```bash
python main.py search_why "レガシーAPIとの互換性のために複雑な実装をしている箇所"

# 検索件数を変更（デフォルト: 5件）
python main.py search_why "課金処理" --top-k 3
```

**出力例（ターミナル）:**

```
--- #1 [function] process_subscription ---
ファイル : payment/payment_service.py
類似度   : 87.32% (distance=0.1268)
設計思想 :
この関数は旧来の外部決済APIの仕様に合わせるため、意図的にレスポンスの正規化処理を
独自実装しています。外部APIがREST標準に準拠していないことへの技術的妥協と考えられます。
```

---

## ユースケースC: ASTスケルトン解析

### 概要

コードの実装ブロックをプログラムで除去し、クラス名・関数シグネチャ・Docstringのみを残した
「スケルトンコード」を生成してAIに送ります。
4096トークン制限下でも複数ファイルを俯瞰でき、モジュール間の構造をAIが評価します。

### コマンド

```bash
# 結果を標準出力に表示
python main.py review_architecture <ディレクトリ>

# 結果をMarkdownファイルに保存
python main.py review_architecture <ディレクトリ> --output <出力ファイル>
```

### 使用例

```bash
python main.py review_architecture ./src --output ai_audit/docs/architecture_review.md
```

**出力例（ターミナル）:**

```
[INFO] スケルトン生成完了: 8 ファイル, 2 バッチで処理
  [REVIEW] バッチ 1/2 を送信中...
  [REVIEW] バッチ 2/2 を送信中...
[INFO] レポートを保存しました: ai_audit/docs/architecture_review.md
```

---

## VSCode 拡張機能の使い方

`vscode-extension/` に VSCode 拡張が含まれています。
**ターミナルを一切触らず**、エディタを離れずにレビュー結果が確認できます。

### Before（拡張なし）
```
コードを書く → ターミナルに切り替え → python main.py audit <file> 実行
→ *_audit.json を開いて指摘を読む → エディタに戻る
```

### After（拡張あり）
```
コードを書く → Ctrl+S で保存
→ [自動・バックグラウンド] 数秒後に問題のある行へ波線が出る
→ 波線にカーソルを合わせるだけで指摘内容と修正提案が読める
```

### インストール手順

```bash
cd vscode-extension
npm install
npm run compile
```

その後 VSCode で `F5` を押すと拡張が起動します。
詳細は `vscode-extension/README.md` を参照してください。

### 波線の見方

| 色 | 重要度 | 例 |
|---|---|---|
| 赤波線 | high | セキュリティ脆弱性 |
| 黄波線 | medium | 保守性・可読性の問題 |
| 青波線 | low | 軽微な指摘（設定で表示/非表示を切り替え可） |

波線にカーソルを合わせると、指摘内容と修正提案がポップアップで表示されます。

### VSCode 設定項目

| 設定キー | デフォルト | 説明 |
|---|---|---|
| `aiAudit.pythonPath` | `python` | Python 実行ファイルのパス |
| `aiAudit.mainScriptPath` | `""` | main.py のフルパス（空=自動検出） |
| `aiAudit.enableOnSave` | `true` | 保存時に自動監査するか |
| `aiAudit.showInformationDiagnostics` | `false` | low 重要度も波線表示するか |

---

## ヘルプの確認

```bash
# 全コマンド一覧
python main.py --help

# 各コマンドの詳細
python main.py config --help
python main.py audit --help
python main.py extract_why --help
python main.py search_why --help
python main.py review_architecture --help
```

---

## ファイル構成

```
ai_audit/
  __init__.py
  ast_parser.py       # ASTチャンク化・ファイルスキャン
  token_counter.py    # 文字数ベースのトークン管理（2000文字上限）
  llm_client.py       # LLM APIクライアント（OpenAI互換、リトライ付き）
  cache_manager.py    # SQLiteキャッシュ（SHA-256で変更検知）
  wear_manager.py     # ウェア（システムプロンプト）定義
  config_manager.py   # 設定永続管理（config.json / .env / デフォルト）
  usecase_a.py        # ユースケースA: 多重マイクロ監査
  usecase_b.py        # ユースケースB: 設計思想抽出・検索
  usecase_c.py        # ユースケースC: ASTスケルトン解析
  docs/
    アプリ紹介と使い方.md  ← このファイル

main.py               # CLIエントリーポイント
requirements.txt      # 依存パッケージ
.env.example          # 環境変数サンプル

vscode-extension/
  src/extension.ts    # VSCode拡張本体
  package.json        # 拡張のマニフェスト
  README.md           # VSCode拡張の使い方
```

### データ保存先

デフォルト: `~/.ai_audit/`（`AI_AUDIT_DATA_DIR` 環境変数で変更可）

```
~/.ai_audit/
  ├─ config.json    : CLI で変更した設定（モデル名・トークン数等）
  ├─ cache.db       : SQLite キャッシュ（監査結果・チャンクハッシュ）
  └─ chroma/        : ChromaDB（設計思想ベクトルDB）
```

---

## 関連設計ドキュメント（docs/）

| ドキュメント | 概要 |
|---|---|
| `1. 120Bモデル×4096トークン環境向け 生成AI活用設計書.md` | 設計思想・アーキテクチャ概要 |
| `2. 詳細設計書_ユースケースA_多重マイクロ監査.md` | ユースケースAの詳細仕様 |
| `3. 詳細設計書_ユースケースB_設計思想の抽出と蓄積.md` | ユースケースBの詳細仕様 |
| `4. 詳細設計書_ユースケースC_ASTスケルトン解析.md` | ユースケースCの詳細仕様 |
| `5. 大コンテキスト時代を見据えたロードマップ.md` | MVP以降の展望 |
